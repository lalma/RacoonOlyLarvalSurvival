library(survminer)
library(ggplot2)
library(survival)
library(frailtyEM)
library(tidyverse)
library(here)
library(readxl)
# Select dataset, import my dataset here, has the same headings as pauls dataset for simplicity
OlyLarvaeKMforR <- read_excel("C:/Users/Lindsay/Dropbox/Raccoon/larvae/oyster/larvae survival stats/GitHub/RacoonOlyLarvalSurvival/OlyLarvaeKMforR.xlsx")#  dataset is d
d <- OlyLarvaeKMforR
View(d)
#make surv object
surv = Surv(time = d$day, d$dead, type = "right")
# coxph
# fit model and plot without random effect
sf <- survfit(surv ~ Treatment+Location, data = d)
summary(coxph(surv ~ Treatment+Location, data = d))
#basic KM plot
ggsurvplot(sf, conf.int = TRUE)
#Plot KM curves- will prob use this one for paper. Use code from R file RaccoonLarvaeSurvialCurves. contains all data
#if we use the subset with 2000 lines, the confidence interval is much fatter
ggsurvplot(sf, conf.int=T, risk.table=F, pval=F,legend=c("right"),
legend.labs=c("CI20-14C","CI5-14C","DB-14C","PW-14C", "CI20-20C", "CI5-20C", "DB-20C", "PW-20C"),legend.title="Treatment",
palette =  c('darkgreen', 'blue4', 'darkred', 'darkgoldenrod', '#33CC66','steelblue','red','darkgoldenrod1'),
xlab="Time (days)", size=0.7, break.time.by = 3,  ggtheme = theme_bw() +  theme(
panel.grid.major.y = element_blank(),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank()
))
#Both the Commenges-Andersen test for heterogeneity and the one-sided likelihood ratio test deems the random effect highly significant.
#The Commenges-Andersen score test for heterogeneity (Commenges and Andersen 1995) is implemented in frailtyEM.
summary(fme)
#Best frailty distribution
#find the frailty distribution with the maximium likelihood
frailtyDist <- data.frame(name = c("gamma", "stablePos", "invGausian", "nonCenGamma"),
dist = c("gamma", "stable", "pvf", "pvf"), m = c(0, 0, -0.5, 1))
dLike <- NULL
#indentify the model frailty distribution with the maxium likelihood
#since forloop was not used, created dataset with all distributions and their logLike values to enter into bestDist
dLike <- read_excel("C:/Users/Lindsay/Dropbox/Raccoon/larvae/oyster/larvae survival stats/GitHub/RacoonOlyLarvalSurvival/dLike.xlsx")
bestDist <- dLike$dist[dLike$logLike == max(dLike$logLike)]
# fit model with Group random effect using best fit frailty distribu1tion
#will take a while to run- start 4:15 7-21-21, finish by morning 7-21-21
fme <- emfrail(surv ~ Treatment + Location+ cluster(Group),
#show time points in time at which an individual died
cut.points <- unique(OlyLarvaeKMforR$day[OlyLarvaeKMforR$dead == 1])
#duplicate 4 line per individual, times 0-1, 1-7, 7-10, 10-13 =time0 and time
SURV2 <- survSplit(data = OlyLarvaeKMforR, cut = cut.points, end = "day", start = "day0", event = "dead")
#duplicate 4 line per individual, times 0-1, 1-7, 7-10, 10-13 =time0 and time
SURV2 <- survSplit(data = OlyLarvaeKMforR, cut = cut.points, end = "day", start = "day0", event = "dead")
library(survival)
library(survminer)
library(ggplot2)
library(rms)
library(readxl)
library(survELtest)
#duplicate 4 line per individual, times 0-1, 1-7, 7-10, 10-13 =time0 and time
SURV2 <- survSplit(data = OlyLarvaeKMforR, cut = cut.points, end = "day", start = "day0", event = "dead")
#show time points in time at which an individual died
cut.points <- unique(OlyLarvaeKMforR$day[OlyLarvaeKMforR$dead == 1])
#duplicate 4 line per individual, times 0-1, 1-7, 7-10, 10-13 =time0 and time
SURV2 <- survSplit(data = OlyLarvaeKMforR, cut = cut.points, end = "day", start = "day0", event = "dead")
View(SURV2)
#run the cox model on orginal data- estimates one treatment male-21yrs
model.1 <- coxph(Surv(day, dead) ~ TempAsFactor+Location+TempAsFactor:LocationNumber, data = OlyLarvaeKMforR)
#run the cox model on orginal data- estimates one treatment male-21yrs
model.1 <- coxph(Surv(day, dead) ~ Treatment+Location+Treatment:Location, data = OlyLarvaeKMforR)
model.1
summary(model.1)
#Schoenfeld's global test for the violation of proportional assumption-- Grambsch PM, Therneau TM. Proportional hazards tests
# diagnostics based on weighted residuals. Biometrika 1994;81:515-26
zph<-cox.zph(model.1)
zph
#results of cox.zph show there is significant deviation from the proportional hazards assumption for the variable
covs <- data.frame(Location = "CI20", TempAsFactor = "14C")
covs
summary(survfit(model.1, newdata = covs, type = "aalen"))
#results of cox.zph show there is significant deviation from the proportional hazards assumption for the variable
covs <- data.frame(Location = "CI20", Treatment = "14C")
summary(survfit(model.1, newdata = covs, type = "aalen"))
#output gives us probability of survival for CI20 14C for each day, i.e. a larvae has a .708 chance of survivind to day 4, but 0.163 chance of surviving to day 15
cox.zph(model.1)
#The result of zph shows that there is significant deviation from the proportional hazards assumption for all veriables
ggforest(model.1, SURV2)
#Both the Commenges-Andersen test for heterogeneity and the one-sided likelihood ratio test deems the random effect highly significant.
#The Commenges-Andersen score test for heterogeneity (Commenges and Andersen 1995) is implemented in frailtyEM.
summary(fme)
# fit model with Group random effect using best fit frailty distribu1tion
#will take a while to run- start 4:15 7-21-21, finish by morning 7-21-21
fme <- emfrail(surv ~ Treatment + Location+ cluster(Group),
pvfm = frailtyDist$m[frailtyDist$name == bestDist] ),
distribution = emfrail_dist(dist = frailtyDist$dist[frailtyDist$name == bestDist], pvfm = frailtyDist$m[frailtyDist$name == bestDist] ),
#By default, the predict function creates predictions for each row of newdata or for each value of autopiolt separately
newdata = data.frame(Treatment= unique(d$Treatment), Location = unique(d$Location))
#cox model sample code without interaction
cox1<-coxph(KMsurv~Treatment+Location, data=OlyLarvaeKMforR)
KMsurv = Surv(time = OlyLarvaeKMforR$day, OlyLarvaeKMforR$dead, type = "right")
# fit KM model and plot without random effect of tank
sf <- survfit(KMsurv ~ Treatment+Location, data = OlyLarvaeKMforR)
summary(coxph(KMsurv ~ Treatment*Location, data = OlyLarvaeKMforR))
# Graph the KMsurvival distribution
#you can add pval = TRUE, but we know our p>0.0001
ggsurvplot(sf, conf.int = 0.05)
# another type of graph
plot(sf, xlab="Larval Age",
ylab="% Surviving", yscale=100, col=c("springgreen4", "royalblue3", "red","orange2","springgreen2","dodgerblue","indianred","gold1"),
main="% Larval Survival")
#Plot with breaktime by = # of days, palette=number of treatments listed colors
fontsize<-20
pCox <- ggsurvplot(sf, data=OlyLarvaeKMforR, risk.table = FALSE, pval = FALSE, conf.int = TRUE,
font.main = fontSize, font.x =  fontSize, font.y = fontSize,
font.tickslab = fontSize, font.legend = fontSize,
palette = c("springgreen4", "royalblue3", "red","orange2","springgreen2","dodgerblue","indianred","gold1"), legend = "none"
) +  xlab("Time (d)")
pCox$plot
#add a legend, dont need. probably make one not on R
legend("topright" , c("CI20-14C","CI5-14C","DB-14C","PW-14C", "CI20-20C", "CI5-20C", "DB-20C", "PW-20C"),
fill=c("springgreen4", "royalblue3", "red","orange2","springgreen2","dodgerblue","indianred","gold1"))
#another type of graph- will prob use this one
ggsurvplot(sf, data=OlyLarvaeKMforR, conf.int=T,  risk.table=F, pval=F,legend=c("right"),
legend.labs=c("CI20-14C","CI5-14C","DB-14C","PW-14C", "CI20-20C", "CI5-20C", "DB-20C", "PW-20C"),legend.title="Treatment",
palette =  c('darkgreen', 'blue4', 'darkred', 'darkgoldenrod', '#33CC66','steelblue','red','darkgoldenrod1'),
risk.table.height=.25,xlab="Time (days)", size=0.7, break.time.by = 3, break.y.by=.2, ggtheme = theme_bw() +  theme(
panel.grid.major.y = element_blank(),
panel.grid.minor.y = element_blank(),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank()
))
#Test non parametric (logrank test) p<0.0001 chisq=4053
#report this value in paper to compare data from multuple pairwise groups
#log-rank test does not make assumptions about survival distribution. Analyzes each cohort separetely.
" When
survival curves cross, the log-rank test should not be
used because the probability of a type II error will be
increased, and the test has low power."
survdiff(formula=Surv(day,dead)~Treatment +Location, data=OlyLarvaeKMforR)
#emperica likelyhood-optimize power
#p-value <0.0001
surv_pvalue(sf)
#cox model sample code without interaction
cox1<-coxph(KMsurv~Treatment+Location, data=OlyLarvaeKMforR)
summary(cox1)
#38400 larvae, 25506 death, 12894 censored
#Looking at exp(coef)-- for example the Hazard Ratio of 20C is 0.586, this means that each additional
#day is associated with a 0.586 fold increse in the hazard death when compared to 14C, and its 95% confidence
#interval is (0.56,0.61). I think..Since this confidence interval is <1
#it indicates a decrease in the hazard survival compared to 14C, and there is a significant association
#between days and temperature (p<0.0001)
anova(cox)
#cox model sample code with interaction, this is the model for the main analysis
cox<-coxph(KMsurv~Treatment*Location, data=OlyLarvaeKMforR)
#38400 larvae, 25506 death, 12894 censored
#Looking at exp(coef)-- for example the Hazard Ratio of 20C is 0.586, this means that each additional
#day is associated with a 0.586 fold increse in the hazard death when compared to 14C, and its 95% confidence
#interval is (0.56,0.61). I think..Since this confidence interval is <1
#it indicates a decrease in the hazard survival compared to 14C, and there is a significant association
#between days and temperature (p<0.0001)
anova(cox)
cox.zph(cox)
summary(cox)
#38400 larvae, 25506 death, 12894 censored
#Looking at exp(coef)-- for example the Hazard Ratio of 20C is 0.586, this means that each additional
#day is associated with a 0.586 fold increse in the hazard death when compared to 14C, and its 95% confidence
#interval is (0.56,0.61). I think..Since this confidence interval is <1
#it indicates a decrease in the hazard survival compared to 14C, and there is a significant association
#between days and temperature (p<0.0001)
anova(cox)
plot(cox.zph(cox))
cox.zph(cox)
#show time points in time at which an individual died
cut.points <- unique(OlyLarvaeKMforR$day[OlyLarvaeKMforR$dead == 1])
#duplicate 4 line per individual, times 0-1, 1-7, 7-10, 10-13 =time0 and time
SURV2 <- survSplit(data = OlyLarvaeKMforR, cut = cut.points, end = "day", start = "day0", event = "dead")
View(SURV2)
cut.points
#run the cox model on orginal data- estimates one treatment male-21yrs
model.1 <- coxph(Surv(day, dead) ~ Treatment+Location+Treatment:Location, data = OlyLarvaeKMforR)
model.1
#output gives us probability of survival for CI20 14C for each day, i.e. a larvae has a .708 chance of survivind to day 4, but 0.163 chance of surviving to day 15
cox.zph(model.1)
plot(cox.zph(model.1))
